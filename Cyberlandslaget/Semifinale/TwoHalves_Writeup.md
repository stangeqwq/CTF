# Two-Halves - crypto
En krypto-CTF oppgave der man måtte utnytte sårbarheten ved `random` biblioteket i python. 

## Oppgave
Two halves makes a whole. Can you use the given bits to predict the prime, find the twist and decrypt the flag?

## Løsning
Vi er gitt et program `source.py` nedenfor:
```python
from Crypto.Util.number import bytes_to_long, isPrime, getPrime
import random
import os
flag = open("flag.txt").read().strip().encode()


def generate_random_prime():
    while True:
        random.seed(os.urandom(1024))
        bits = [random.getrandbits(32) for _ in range(33)]
        random.getrandbits(364*32)
        bits += [random.getrandbits(32) for _ in range(32)]
        random.getrandbits(195*32)

        n = random.getrandbits(1024)
        if isPrime(n):
            break

    return bits, n


q = getPrime(1024)
bits, p = generate_random_prime()

n = p*q
e = 0x10001
ct = pow(bytes_to_long(flag), e, n)
print(f"bits={bits}")
print(f"n={n}")
print(f"ct={ct}")
```
Vi får 65 32-bit integers som vi kan bruke til å finne ut hva tallet `p` var i `n`. Slik blir det mulig å finne ut `q` ved `n // p`. 

Skriptet blir da der vi fôrer inn tallene i `bits`.
```python
from randcrack import RandCrack
import random
bits=[1345733645, 2981438078, 2419713692, 3943527837, 670420293, 2759536261, 3957113669, 1228960007, 3954269360, 2978090950, 3045378982, 1917101448, 1530104058, 2860291334, 2869144081, 790490861, 1026649369, 730515920, 633841782, 1571404, 1986887962, 3338823063, 1316961744, 1386309373, 4060329152, 2059377879, 2041216609, 155215036, 2603958764, 3563537920, 3486715705, 473742603, 335139614, 3105784935, 3235264465, 4291091898, 3397730837, 3652355291, 4294586318, 445284593, 3962482932, 1891622122, 3624669423, 340540467, 4125076014, 2981206673, 505528388, 1781578815, 1845924109, 526167588, 3182187429, 1549373845, 684196342, 1926930222, 85110360, 563276497, 3948496155, 620965897, 3705304715, 134614304, 3832525041, 1391065293, 2801782394, 284249999, 1967091103]

rc = RandCrack()

for i in range(33):
	rc.submit(bits[i])
for i in range(364):
	rc.submit(random.randint(0,4294967294))
for i in range(32):
	rc.submit(bits[i+33])
for i in range(195):
	rc.submit(random.randint(0,4294967294))
print(rc.predict_randrange(0,2**1024-1))
```

Vi sjekker om prediksjonen av `randcrack` er riktig.
```console
stange@ericjoshua handout % python3
Python 3.11.2 (main, Mar 24 2023, 00:16:47) [Clang 14.0.0 (clang-1400.0.29.202)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> 634675105213369319865742493786072222348038051639799670211495325490791390013681558062373561906030224190114689321706828105555114229576742206527224391654808118116954225528162769314411555378435425094056041548347046904800845658715490152647313303632615938533279623548332444427399814251754108714429833897102650208769313361707739701933544117464782639369286486823613136824452054592873111644604646533440053671286296097805805993741595553335742934138809392794177643197968937779875186503731144373821823708828851910250053861151669764630001342895594555806131246170085189386588178847836331728160113922341933400189739102535724238787%4772612605468467764007483688902097944562160107244885013216395089902903683578481258858850513137129536527669445135136394972631691847810969454249784951096034928774045316683404586720733708492945491004631020647685860405530201990381125740869691275324326764554848488840313263611648984871856145684659138083010773007
0
```
Vi vet primtallene som var blitt brukt til a kryptere flagget. Dermed kan vi enkelt dekryptere flagget. `chatGPT` er et nyttig verktøy for å automatisere denne delen, uansett skriptet var:
```python
from Crypto.Util.number import long_to_bytes
n = 634675105213369319865742493786072222348038051639799670211495325490791390013681558062373561906030224190114689321706828105555114229576742206527224391654808118116954225528162769314411555378435425094056041548347046904800845658715490152647313303632615938533279623548332444427399814251754108714429833897102650208769313361707739701933544117464782639369286486823613136824452054592873111644604646533440053671286296097805805993741595553335742934138809392794177643197968937779875186503731144373821823708828851910250053861151669764630001342895594555806131246170085189386588178847836331728160113922341933400189739102535724238787
p = 4772612605468467764007483688902097944562160107244885013216395089902903683578481258858850513137129536527669445135136394972631691847810969454249784951096034928774045316683404586720733708492945491004631020647685860405530201990381125740869691275324326764554848488840313263611648984871856145684659138083010773007
ct = 261701236354833316063005554214902804090956241455310571816739231156088299516015787714542362461498895540454248186293788651637473227604586354616977772019053536210209117317475466030334480652394993085046900964896452179831257622617653981329353714618781011741789858006331893467190930666550637501712514018555654083769589831024269428874790982997938163721254438747349307905794423769200179975458939429777324669649932358532623257216035853599585705390589641770826211915874309485622243165723313147248443968542912852724114213555124363478865123014636619392056889207161956370097247723074834632651959855550692409114160215251468363771
e = 0x10001
q = n // p
phi = (p - 1) * (q - 1)
d = pow(e, -1, phi)
pt = pow(ct, d, n)


print(long_to_bytes(pt))
```
```console
stange@ericjoshua handout % sage decrypt.py
b'flag{MT19937_iZ_JuST_a_f@ncY_X0R_maChiNe}'
```
